<script>
  const eintraege = [];
  const exportierteEintraege = JSON.parse(localStorage.getItem("skitestExportiert") || "[]");

  function addEintrag(eintrag) {
    eintraege.push(eintrag);
    renderTable();
  }

  function renderTable() {
    const tbody = document.querySelector('#adminTable tbody');
    tbody.innerHTML = '';
    eintraege.forEach((e, i) => {
      if (e.Status !== 'Ski unterwegs') return;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${e.Modell}</td>
        <td>${e.Datum}</td>
        <td>${e.Ort}</td>
        <td>${e.SkitestOrt}</td>
        <td>${e.Name}</td>
        <td>${e.PLZOrt || ''}</td>
        <td>${e.Email || ''}</td>
        <td>${e.Telefon || ''}</td>
        <td>${e.SkiNummer}</td>
        <td class="status-cell ${e.Status === 'Ski verfügbar' ? 'available' : 'unavailable'}" data-idx="${i}">${e.Status}</td>
        <td><button class="small-button" onclick="markAsDone(${i})" ${e.Status !== 'Ski verfügbar' ? 'disabled' : ''}>Als erledigt speichern</button></td>
      `;
      tbody.appendChild(tr);
    });

    document.querySelectorAll('.status-cell').forEach(cell => {
      const i = cell.dataset.idx;
      cell.onclick = () => {
        eintraege[i].Status = (eintraege[i].Status === 'Ski verfügbar') ? 'Ski unterwegs' : 'Ski verfügbar';
        renderTable();
      };
    });
  }

  function markAsDone(i) {
    // 1. In exportierte Liste verschieben
    exportierteEintraege.push(eintraege[i]);
    localStorage.setItem("skitestExportiert", JSON.stringify(exportierteEintraege));

    // 2. Aus aktiven Anmeldungen (in Speicher) entfernen
    eintraege.splice(i, 1);
    localStorage.setItem("skitestEintraege", JSON.stringify(eintraege));

    renderTable();
  }

  function exportAll() {
    if (exportierteEintraege.length === 0) {
      alert('Keine gespeicherten Rückgaben vorhanden.');
      return;
    }

    const header = Object.keys(exportierteEintraege[0]).join("\\t");
    const rows = exportierteEintraege.map(e => Object.values(e).join("\\t"));
    const csv = [header, ...rows].join("\\n");
    const blob = new Blob([csv], { type: 'application/vnd.ms-excel' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'skitest_rueckgaben.xls';
    link.click();
  }

  // Nur NICHT exportierte laden
  const gespeicherteEintraege = JSON.parse(localStorage.getItem('skitestEintraege') || '[]');
  gespeicherteEintraege.forEach(entry => {
    if (!entry.Status) entry.Status = 'Ski unterwegs';
    eintraege.push(entry);
  });
  renderTable();
</script>
