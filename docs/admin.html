<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Skitest Übersicht (Intern)</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f5f5f5; }
    .container { background: white; padding: 20px; border-radius: 10px; max-width: 1200px; margin: auto; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    h2 { margin-bottom: 10px; }
    .toolbar { display:flex; align-items:center; gap:16px; margin-bottom:12px; flex-wrap: wrap; }
    .toolbar label { display:flex; align-items:center; gap:8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #eee; }
    tr:hover { background-color: #f1f1f1; }
    .status-cell { font-weight: bold; cursor: pointer; }
    .status-cell.available { background-color: #d4edda; color: #155724; }
    .status-cell.unavailable { background-color: #f8d7da; color: #721c24; }
    .small { font-size: 12px; color: #666; }
    button.export-button, button.refresh-button {
      margin-top: 20px; padding: 10px; background-color: #007bff;
      color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer;
    }
    button.refresh-button { background-color: #28a745; }
    .center { text-align:center; }
    details { margin-top:10px; }
    pre { background:#fafafa; border:1px solid #ddd; padding:10px; border-radius:8px; max-height:240px; overflow:auto; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Übersicht: Skitest-Anmeldungen</h2>

    <!-- Debug-Zeile -->
    <div id="debug" class="small" style="color:#666; margin-bottom:8px;"></div>

    <div class="toolbar">
      <label>
        <input type="checkbox" id="filterUnterwegs" />
        Nur „Ski unterwegs” anzeigen
      </label>
      <span class="small">Status klickbar: „Ski unterwegs“ ⇄ „Ski verfügbar“. Export nur über „Retour“.</span>
      <button class="refresh-button" onclick="refreshNewEntries()">Neue Einträge hinzufügen</button>
      <button class="export-button" onclick="exportAll()">Alle gespeicherten Rückgaben exportieren</button>
    </div>

    <table id="adminTable">
      <thead>
        <tr>
          <th>Modell</th>
          <th>Datum</th>
          <th>Ort</th>
          <th>Ort Test</th>
          <th>Name</th>
          <th>Adresse / PLZ, Ort</th>
          <th>E-Mail</th>
          <th>Telefon</th>
          <th>Ski-Nr.</th>
          <th>Status <br><span class="small">(klicken zum Umschalten)</span></th>
          <th class="center">Retour</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="leerHinweis" style="margin-top:20px; text-align:center; color:gray;"></div>

    <!-- Rohdaten-Panel (Debug) -->
    <details>
      <summary>Rohdaten anzeigen (Debug)</summary>
      <pre id="raw"></pre>
    </details>
  </div>

  <script>
    // ===== Utilities =====
    function safeParse(s){ try{ return s ? JSON.parse(s) : null; } catch { return null; } }

    // ===== State =====
    let eintraege = safeParse(localStorage.getItem("skitestEintraege")) || [];
    let exportierteEintraege = safeParse(localStorage.getItem("skitestExportiert")) || [];
    let lastSeenUpdate = localStorage.getItem("skitestLastUpdate") || "";

    const filterBox = document.getElementById('filterUnterwegs');
    filterBox.addEventListener('change', renderTable);

    // Live-Update über localStorage-Events
    window.addEventListener('storage', (e) => {
      if (e.key === 'skitestEintraege' || e.key === 'skitestLastUpdate') {
        refreshNewEntries();
      }
    });
    // Instant-Update über BroadcastChannel
    try {
      const bc = new BroadcastChannel('skitest');
      bc.onmessage = (ev) => { if (ev?.data === 'updated') refreshNewEntries(); };
    } catch {}

    // Fallback: Polling alle 2s
    setInterval(() => {
      const now = localStorage.getItem("skitestLastUpdate") || "";
      if (now && now !== lastSeenUpdate) {
        lastSeenUpdate = now;
        refreshNewEntries();
      }
    }, 2000);

    function combineAddress(e) {
      if (e.Adresse_PLZOrt) return e.Adresse_PLZOrt; // neue Struktur
      if (e.Adresse || e.PLZ || e.Ort2) {            // alte Struktur
        const rechts = [e.PLZ, e.Ort2].filter(Boolean).join(", ");
        return [e.Adresse, rechts || null].filter(Boolean).join(" / ");
      }
      if (e.PLZOrt) return e.PLZOrt;                 // ganz alt
      return "";
    }

    function renderTable() {
      const tbody = document.querySelector('#adminTable tbody');
      const leerHinweis = document.getElementById('leerHinweis');
      tbody.innerHTML = '';

      const onlyUnterwegs = filterBox.checked;
      const view = eintraege.filter(e => !onlyUnterwegs || e.Status === 'Ski unterwegs');

      view.forEach((e) => {
        const i = eintraege.indexOf(e);
        const tr = document.createElement('tr');
        const isAvail = e.Status === 'Ski verfügbar';
        const statusClass = isAvail ? 'available' : 'unavailable';

        tr.innerHTML = `
          <td>${e.Modell || ''}</td>
          <td>${e.Datum || ''}</td>
          <td>${e.Ort || ''}</td>
          <td>${e.SkitestOrt || ''}</td>
          <td>${e.Name || ''}</td>
          <td>${combineAddress(e)}</td>
          <td>${e.Email || ''}</td>
          <td>${e.Telefon || ''}</td>
          <td>${e.SkiNummer || ''}</td>
          <td class="status-cell ${statusClass}" data-idx="${i}">${e.Status || ''}</td>
          <td class="center"><input type="checkbox" data-retour-idx="${i}" title="Als retour markieren" /></td>
        `;
        tbody.appendChild(tr);
      });

      leerHinweis.textContent = view.length === 0 ? "Keine Einträge für diese Ansicht." : "";

      // Status toggeln (nicht entfernen)
      document.querySelectorAll('.status-cell').forEach(cell => {
        const i = +cell.dataset.idx;
        cell.onclick = () => {
          eintraege[i].Status = (eintraege[i].Status === 'Ski verfügbar') ? 'Ski unterwegs' : 'Ski verfügbar';
          localStorage.setItem("skitestEintraege", JSON.stringify(eintraege));
          localStorage.setItem("skitestLastUpdate", String(Date.now()));
          try { new BroadcastChannel('skitest').postMessage('updated'); } catch {}
          renderTable();
        };
      });

      // Retour → exportieren & entfernen
      document.querySelectorAll('input[type="checkbox"][data-retour-idx]').forEach(box => {
        box.onchange = () => {
          const idx = Number(box.getAttribute('data-retour-idx'));
          if (box.checked) markAsReturned(idx);
        };
      });

      updateDebug();
      updateRaw();
    }

    function markAsReturned(i) {
      const entry = { ...eintraege[i], RueckgabeDatum: new Date().toISOString().slice(0,10) };

      const already = exportierteEintraege.some(ex =>
        ex.Name === entry.Name && ex.Datum === entry.Datum && ex.SkiNummer === entry.SkiNummer
      );
      if (!already) {
        exportierteEintraege.push(entry);
        localStorage.setItem("skitestExportiert", JSON.stringify(exportierteEintraege));
      }

      eintraege.splice(i, 1);
      localStorage.setItem("skitestEintraege", JSON.stringify(eintraege));
      localStorage.setItem("skitestLastUpdate", String(Date.now()));
      try { new BroadcastChannel('skitest').postMessage('updated'); } catch {}

      renderTable();
    }

    function exportAll() {
      exportierteEintraege = safeParse(localStorage.getItem("skitestExportiert")) || [];
      if (exportierteEintraege.length === 0) {
        alert('Keine gespeicherten Rückgaben vorhanden.');
        return;
      }

      const header = [
        "Modell","Datum","Ort","Ort Test","Name","Adresse / PLZ, Ort",
        "E-Mail","Telefon","Ski-Nr.","Status","Rückgabedatum"
      ];

      const rows = exportierteEintraege.map(e => [
        e.Modell || '',
        e.Datum || '',
        e.Ort || '',
        e.SkitestOrt || '',
        e.Name || '',
        combineAddress(e),
        e.Email || '',
        e.Telefon || '',
        e.SkiNummer || '',
        e.Status || '',
        e.RueckgabeDatum || ''
      ]);

      const csv = [header.join("\t"), ...rows.map(r => r.join("\t"))].join("\n");
      const blob = new Blob([csv], { type: 'application/vnd.ms-excel' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'skitest_rueckgaben.xls';
      link.click();
    }

    function refreshNewEntries() {
      const alle = safeParse(localStorage.getItem("skitestEintraege")) || [];
      const exported = safeParse(localStorage.getItem("skitestExportiert")) || [];
      exportierteEintraege = exported;

      eintraege = alle.filter(e =>
        !exported.some(ex => ex.Name === e.Name && ex.Datum === e.Datum && ex.SkiNummer === e.SkiNummer)
      );
      renderTable();
    }

    function updateDebug() {
      const arr = safeParse(localStorage.getItem("skitestEintraege")) || [];
      const last = localStorage.getItem("skitestLastUpdate") || "-";
      const dbg = document.getElementById('debug');
      if (dbg) dbg.textContent = `Origin: ${location.origin} | Einträge: ${arr.length} | LastUpdate: ${last}`;
    }

    function updateRaw() {
      const raw = document.getElementById('raw');
      if (!raw) return;
      const o = {
        skitestEintraege: safeParse(localStorage.getItem("skitestEintraege")) || [],
        skitestExportiert: safeParse(localStorage.getItem("skitestExportiert")) || [],
        skitestLastUpdate: localStorage.getItem("skitestLastUpdate") || null
      };
      raw.textContent = JSON.stringify(o, null, 2);
    }

    // Initial
    refreshNewEntries();
  </script>
</body>
</html>
